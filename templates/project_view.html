<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/layout.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        

        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #0e0e0e; color: white; overflow: hidden; }
        .main-container { display: flex; height: 100vh; width: 100vw; }
        
        /* Permanent Right Side Notebook */
        .rhs-notebook { width: 50%; border-left: 1px solid #333; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; background: #1a1a1a; }
        
        /* Left Side Tabbed Interface */
        .lhs-workspace {
    width: 50%;
    display: flex;
    flex-direction: column;
    background: #151515;
    height: 100vh;
    overflow: hidden; /* Prevents unwanted scrollbars */
}
        
        /* Chrome-like Tab Bar */
        .tab-bar { display: flex; background: #000; padding-top: 10px; padding-left: 10px; border-bottom: 1px solid #333; }
        .tab { padding: 10px 20px; border-radius: 10px 10px 0 0; cursor: pointer; background: #222; color: #888; margin-right: 5px; font-size: 0.9rem; transition: 0.2s; border: 1px solid transparent; }
        .tab.active { background: #1a1a1a; color: black; border: 1px solid #333; border-bottom: 1px solid #1a1a1a; }
        
        .tab-content { flex-grow: 1; padding: 30px; display: none; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }

        /* Video Bank (Squircles) */
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        .video-squircle {
    /* 1. Force a constant 1:1 shape regardless of text */
    aspect-ratio: 1 / 1;
    width: 100%; /* Let the grid-container define the width */
    max-width: 75px; /* Adjust this to your preferred size */
    
    /* 2. Visual Foundation */
    background: #1a1a1a;
    border-radius: 20px; /* More 'squircle-like' rounding */
    border: 2px solid #333;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    
    /* 3. The 'Magic' for Long Titles */
    display: -webkit-box;
    /* -webkit-line-clamp: 4; Limits text to exactly 4 lines */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
    
    /* 4. Layout */
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 0.85rem;
    font-weight: 500;
    color: #eee;
}
        .video-squircle:hover { border-color: #bfecac; background: #333; }

        /* Modal / Pop-up */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; padding: 40px; border-radius: 20px; width: 70%; max-height: 80%; overflow-y: auto; border: 1px solid #333; }

        textarea { background: #111; color: #ddd; border: 1px solid #333; padding: 15px; border-radius: 10px; resize: none; flex-grow: 1; font-size: 1.1rem; line-height: 1.6; }
        .primary-btn { background: #bfecac; color: black; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; }

        /* Context Selection Glow for Squircles */
        .video-squircle.selected {
            border: 2px solid #ffcc00 !important;
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.4);
            transform: scale(1.02);
        }

        /* New Pill Input Bar */
        .chat-input-pill {
            display: flex;
            align-items: center;
            background: #111;
            border: 1px solid #333;
            border-radius: 24px;
            padding: 6px 12px;
            gap: 10px;
            min-height: 48px;
        }

        .input-left-section {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .add-context-btn {
            background: transparent;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
        }

        .pill-display {
            display: flex;
            gap: 6px;
            max-width: 300px;
            overflow-x: auto;
        }

        .context-pill {
            background: #222;
            color: #efefef;
            border: 1px solid #444;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .context-pill i {
            cursor: pointer;
            color: #888;
        }

        #chat-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            outline: none;
            resize: none;
            font-size: 14px;
            padding: 10px 0;
            
        }

        .send-circle {
            background: white;
            color: black;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-circle:hover {
    background: #bfecac; /* Your signature Mint Green */
    transform: scale(1.1); /* Adds a nice "pop" effect on hover */
}
        

        .context-popup {
    position: absolute;
    bottom: 60px; /* Floats above the input bar */
    left: 0;
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    width: 250px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    padding: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
}

.context-popup h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #888;
}

.context-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #2a2a2a;
    font-size: 13px;
    cursor: pointer;
}

.context-item:hover { color: #bfecac; }

.context-item.active { color: #bfecac; font-weight: bold; }

.clear-all-btn {
    width: 100%;
    margin-top: 10px;
    background: #333;
    border: none;
    color: white;
    padding: 5px;
    border-radius: 4px;
    cursor: pointer;
}

/* Container for the bubbles */
#chat-window {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* Base Bubble Style */
.message-bubble {
    padding: 12px 16px;
    border-radius: 14px;
    max-width: 85%;
    font-size: 14px;
    line-height: 1.6;
    word-wrap: break-word;
}

/* User: Blue bubble on the right */
.user-msg {
    align-self: flex-end;
    background: #bfecac;
    color: white;
    border-bottom-right-radius: 2px;
}

/* Model (AI): Dark bubble on the left */
.model-msg {
    align-self: flex-start;
    background: #222;
    color: #efefef;
    border: 1px solid #333;
    border-bottom-left-radius: 2px;
}

/* Ensure code blocks inside bubbles look like Gemini/ChatGPT */
.model-msg pre {
    background: #000;
    padding: 10px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 10px 0;
    border: 1px solid #444;
}

.resizer {
        width: 8px;
        background: #222;
        cursor: col-resize;
        transition: background 0.2s;
        z-index: 100; /* Ensure it stays above content */
    }
    .resizer:hover, .resizer.active {
        background: #bfecac;
    }
    
    /* CRITICAL: Prevent text selection while dragging */
    .resizing-active {
        cursor: col-resize;
        user-select: none;
    }

    /* Position the bubble relatively so the button can anchor to its corner */
.model-msg {
    position: relative;
    padding-bottom: 25px !important; /* Extra space for the button */
}

.add-to-notes-btn {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 28px;
    height: 28px;
    background: #333;
    border: 1px solid #444;
    color: #888;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 12px;
}

.add-to-notes-btn:hover {
    background: #bfecac; /* Project's primary blue */
    color: #1e1e1e;
    border-color: #bfecac;
    transform: scale(1.1);
}

/* Maintain your original class name */
.video-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
}

/* This is the style for the items injected into the grid */
.video-item-squircle {
    width: 80px;
    height: 80px;
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 20px; /* The 'Squircle' shape */
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    overflow: hidden;
    position: relative;
}

.video-item-squircle:hover {
    border-color: #bfecac;
    transform: translateY(-3px);
}

.video-item-squircle i {
    font-size: 24px;
    color: #bfecac;
}

/* This is the most important rule for tab switching */
/* FORCE hide everything that isn't active */
/* 1. LAYOUT & TABS VISIBILITY */
.tab-content:not(.active) {
    display: none !important;
    height: 0 !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
}

.tab-content.active {
    display: flex !important;
    flex-direction: column;
    height: 100%;
}

/* 1. THE MAIN TAB BAR CONTAINER */
/* 1. THE BAR: The container that manages the "growing" middle space */
.tab-bar {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important; /* FORCES the growth to happen in the middle */
    width: 100% !important;
    box-sizing: border-box !important;
    padding: 10px 10px 10px 15px !important; /* Locked 10px padding on the far right */
    background: transparent;
}

/* 2. LEFT SIDE: Back Arrow + Project Name */
.nav-group {
    display: flex !important;
    align-items: center !important;
    gap: 12px !important; /* Constant gap between arrow and name */
    flex-shrink: 0; /* Prevents the left side from collapsing */
}

#project-title-display {
    color: #eee;
    font-size: 1rem;
    font-weight: 600;
    white-space: nowrap;
}

/* 3. RIGHT SIDE: The Tab Unit (The constant group) */
.pill-group {
    display: flex !important;
    gap: 5px !important; /* CONSTANT space between tabs as demanded */
    flex-shrink: 0; /* Prevents the tab group from shrinking or growing */
    padding: 0 !important;
    margin: 0 !important;
}

/* 4. UNIFIED PILL STYLING */
.tab, .back-pill {
    padding: 6px 14px;
    border-radius: 50px; /* Pill shape */
    background: #1a1a1a;
    color: #888;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid #333;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
}

.back-pill {
    width: 32px;
    height: 32px;
    padding: 0;
}

/* 5. HOVER & ACTIVE (The Blue Theme) */
.tab:hover, .back-pill:hover {
    transform: scale(1.05); /* Slightly bigger */
    color: #bfecac;
    border-color: #bfecac;
}

.tab.active {
    background: #bfecac !important;
    color: #151515 !important;
    border-color: #bfecac !important;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3); /* Blue glow */
}

.modal-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex; align-items: center; justify-content: center;
    z-index: 2000;
}

.modal-content {
    background: #121212; /* Your signature dark gray */
    padding: 30px;
    border-radius: 15px;
    border: 1px solid #333;
    max-width: 400px;
    text-align: center;
    color: white;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* Updated modal styles for the cancel button */
.secondary-btn {
    background: transparent;
    color: #888;
    border: 1px solid #333;
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.secondary-btn:hover {
    color: white;
    border-color: #666;
    background: rgba(255, 255, 255, 0.05);
}

.primary-btn.notion-proceed {
    background: #bfecac; /* Our signature blue */
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}

.user-msg {
    align-self: flex-end;
    background: #bfecac; /* #bfecac */
    color: #151515 !important; /* Your signature deep dark color */
    border-bottom-right-radius: 4px;
    font-weight: 600; /* Makes dark text easier to read on light backgrounds */
    box-shadow: 0 4px 12px rgba(191, 236, 172, 0.2);
}

/* Model (AI): Transparent/Dark bubble with White Text */
.model-msg {
    align-self: flex-start;
    background: rgba(255, 255, 255, 0.03); /* Very subtle glass effect */
    color: #ffffff !important; /* Pure white as requested */
    border: 1px solid var(--border-glass);
    border-bottom-left-radius: 4px;
}

.styled-select {
    appearance: none; /* Removes default browser arrow */
    -webkit-appearance: none;
    -moz-appearance: none;
    
    background-color: #121212;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23bfecac' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
    
    color: #eee;
    border: 1px solid #333;
    border-radius: 10px;
    padding: 12px 40px 12px 15px; /* Extra padding on right for the arrow */
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    outline: none;
}

.styled-select:hover {
    border-color: #bfecac;
    background-color: #1a1a1a;
    box-shadow: 0 0 10px rgba(191, 236, 172, 0.1);
}

.styled-select:focus {
    border-color: #bfecac;
    box-shadow: 0 0 15px rgba(191, 236, 172, 0.2);
}

/* Style the dropdown options (Limited support, but works for background) */
.styled-select option {
    background-color: #1a1a1a;
    color: #eee;
    padding: 10px;
}


    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>


<div class="main-container" id="main-container">
    <div class="lhs-workspace" id="lhs">
        <div class="tab-bar">
            <div class="nav-group">
                <a href="/dashboard" class="back-pill">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <span id="project-title-display">Project Name</span>
            </div>
            
            <div class="pill-group">
                <div class="tab active" onclick="switchTab(event, 'bank-tab')">Resource Bank</div>
                <div class="tab" onclick="switchTab(event, 'ai-tab')">Chersey AI</div>
                <div class="tab" onclick="switchTab(event, 'more-tab')">Deep Research</div>
            </div>
        </div>

        <div id="bank-tab" class="tab-content active" style="display: block;">
    
            <div id="transcriber-section" style="margin-bottom: 30px; padding-bottom: 20px;">
                <h2>Add New Video Resource</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="url-input" placeholder="Paste YouTube URL..." 
                           style="flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #333; background: #121212; color: white;">
                    
                    <button class="primary-btn" style="margin-top: 0;" onclick="processSource()">
                        Process & Save
                    </button>
                </div>
            </div>
        
            <div id="saved-sources-section">
                <h2>Saved Resources</h2>
                <div class="video-grid" id="video-grid">
                    </div>
            </div>
        </div>

        <div id="ai-tab" class="tab-content">
            <div id="chat-window" style="flex-grow: 1; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; padding: 10px;">
                </div>
        
                <div class="chat-input-pill">
                    <div class="input-left-section" style="position: relative;"> <button class="add-context-btn" title="Manage Context" onclick="toggleContextMenu()">
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <div id="context-selection-menu" class="context-popup" style="display: none;">
                            <h4>Select Research Context</h4>
                            <div id="context-list-items"></div>
                            <button class="clear-all-btn" onclick="clearAllContext()">Clear All</button>
                        </div>
                
                        <div id="context-pill-container" class="pill-display"></div>
                    </div>
                
                    <textarea id="chat-input" placeholder="Ask your assistant..." rows="1" oninput="autoResize(this)"></textarea>
                
                    <button id="send-btn" onclick="sendMessage()" class="send-circle">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
        </div>

        <div id="more-tab" class="tab-content" style="display: none; padding: 20px;">
            <div class="research-controls" style="margin-bottom: 25px; background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #333;">
                <h3 style="margin-top: 0; color: #bfecac; font-size: 1.1rem;">Deep Research Agent</h3>
                <p style="font-size: 0.85rem; color: #888; margin-bottom: 15px;">Select a video resource, our research agent will intelligently analyze the likely doubts and questions that you might have regarding the topic and suggest best reources to clarify them.</p>
                
                <div style="display: flex; gap: 10px;">
                    <select id="research-context-selector" class="styled-select" style="flex: 1;">
                        <option value="">Select Video Context...</option>
                    </select>
                    
                    <button onclick="runDeepResearch()" class="primary-btn" style="background: #bfecac; white-space: nowrap;">
                        <i class="fas fa-microscope"></i> Start Research
                    </button>
                </div>
            </div>
        
            <div id="research-results-grid" style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <div style="text-align: center; color: #555; margin-top: 40px;">
                    <i class="fas fa-search" style="font-size: 2rem; display: block; margin-bottom: 10px;"></i>
                    <p>Select context above to begin research.</p>
                </div>
            </div>
        </div>
    </div>


    <div class="resizer" id="drag-bar"></div>

    <div class="rhs-notebook" id="rhs">
        {% include "notepad.html" %}
    </div>
</div>

<div id="video-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" style="float: right; cursor: pointer; color: #666;">&times; Close</span>
        <h2 id="modal-title"></h2>
        <a id="modal-link" href="#" target="_blank" style="color: #bfecac;">View on YouTube</a>
        <hr style="border: 1px solid #333; margin: 20px 0;">
        <div id="modal-transcript" style="white-space: pre-wrap; color: #ccc; line-height: 1.6;"></div>
    </div>
</div>

<div id="notion-popup" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>üöÄ Notion Export (MVP Mode)</h3>
        <p>Currently, in MVP, all exports are synced to the <strong>Developer's Workspace</strong> for demo purposes.</p>
        <p style="font-size: 0.85rem; color: #888;">Production versions will include Public OAuth for individual workspace connections.</p>
        
        <div class="modal-actions">
            <button class="secondary-btn" onclick="toggleNotionPopup(false)">Cancel</button>
            <button class="primary-btn" onclick="triggerActualSync()">Proceed with Sync</button>
        </div>
    </div>
</div>

<script>
    // --- 0. BREADCRUMB: IDs CHECK ---
    const userUid = localStorage.getItem("user_uid");
    // filter(Boolean) ensures we don't get an empty ID from a trailing slash
    const projectId = window.location.pathname.split('/').filter(Boolean).pop();

    // This bridges the gaps so your code doesn't throw ReferenceErrors
    // const collection = (db, ...path) => db.collection(path.join('/'));
    // const doc = (db, ...path) => db.doc(path.join('/'));
    // const getDocs = (ref) => ref.get();
    // const addDoc = (ref, data) => ref.add(data);
    // const deleteDoc = (ref) => ref.delete();
    // const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

    let selectedContext = [];
    let allProjectSources = [];
    
    console.log("üìç [STEP 1] Script loaded. Checking IDs...");
    console.log("   - User UID:", userUid);
    console.log("   - Project ID:", projectId);

    // --- TAB SWITCHING LOGIC ---
    function switchTab(evt, tabId) {
        console.log(`üìë [TAB] Switching to: ${tabId}`);
        let contents = document.getElementsByClassName("tab-content");
        for (let content of contents) content.classList.remove("active");

        let tabs = document.getElementsByClassName("tab");
        for (let tab of tabs) tab.classList.remove("active");

        document.getElementById(tabId).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    function truncateTitle(title, limit = 11) {
        if (title.length > limit) {
            return title.substring(0, limit) + "...";
        }
        return title;
    }

    // --- POPUP LOGIC ---
    function openModal(title, link, transcript) {
        console.log(`üñºÔ∏è [MODAL] Opening: ${title}`);
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-link").href = link;
        document.getElementById("modal-transcript").innerText = transcript;
        document.getElementById("video-modal").style.display = "flex";
    }

    function closeModal() {
        document.getElementById("video-modal").style.display = "none";
    }

    // --- 1. Initial Load: Get Project Name and existing Squircles ---
    async function initializeProject() {
        console.log("üìç [STEP 2] initializeProject() started...");

        if (!userUid || !projectId) {
            console.error("‚ùå [ERROR] Missing critical IDs. Stopping execution.");
            return;
        }

        try {
            console.log(`üìç [STEP 3] Calling Python API: /api/${userUid}/projects/${projectId}`);
            const response = await fetch(`/api/${userUid}/projects/${projectId}`);
            
            console.log("üìç [STEP 4] API Response received. Status:", response.status);

            if (response.ok) {
                const data = await response.json();
                console.log("üìç [STEP 5] Data parsed successfully:", data);

                // Save all sources globally so the Context Manager (+) can see them
                allProjectSources = data.sources || [];

                populateResearchDropdown();

                // --- INSERTED: Fetch saved bookmarks from Firestore ---
                await loadBookmarks(projectId); 


                if (allBookmarks && allBookmarks.length > 0) {
                    console.log(`üìç [DEBUG] Rendering ${allBookmarks.length} saved bookmarks...`);
                    renderResearchCards(allBookmarks);
                } else {
                    console.log("üìç [DEBUG] No bookmarks found in DB to render.");
                }

                // --- ADDED LINE: Update the new Right-Anchored Project Title ---
                const navTitleElem = document.getElementById("project-title-display");
                if (navTitleElem) {
                    navTitleElem.innerText = data.name || "Untitled Project";
                }
                // -------------------------------------------------------------

                // Update Old Title Display (if you're still using it)
                const titleElem = document.getElementById("title-display");
                if (titleElem) {
                    titleElem.innerText = "üõ°Ô∏è " + (data.name || "Untitled Project");
                    console.log("üìç [STEP 6] Title updated on UI.");
                }

                // Render existing sources in the Bank
                if (allProjectSources.length > 0) {
                    console.log(`üìç [STEP 7] Sources found! Count: ${allProjectSources.length}. Sending to renderer...`);
                    renderVideoBank(allProjectSources);
                } else {
                    console.warn("‚ö†Ô∏è [WARNING] No sources found in database.");
                }

                // Load persistent chat history
                loadChatHistory(); 
                
            } else {
                console.error(`‚ùå [ERROR] API returned bad status code: ${response.status}`);
            }
        } catch (err) {
            console.error("‚ùå [ERROR] Network or JS Crash during initialization:", err);
        }
    }
    
// --- 2. Render the "Squircles" (Used for History/Reload) ---
function renderVideoBank(sources) {
        console.log("üìç [STEP 8] renderVideoBank() loop started...");
        const grid = document.getElementById("video-grid");
        
        if (!grid) {
            console.error("‚ùå [FATAL] Could not find #video-grid in the HTML. Renderer stopped.");
            return;
        }

        grid.innerHTML = ""; // Clear "No sources" text
        
        sources.forEach((src, index) => {
            console.log(`‚ú® [STEP 9.${index}] Drawing squircle for:`, src.id || src.video_id);
            
            // Check for BOTH keys to be safe
            const actualId = src.id || src.video_id || "Unknown";
            const fullTitle = src.title || `Video ${actualId.substring(0,5)}`;

            // --- NEW FUNCTIONALITY: Truncate for UI only ---
            const charLimit = 11; 
            let displayTitle = fullTitle;
            
            if (fullTitle.length > charLimit) {
                displayTitle = fullTitle.substring(0, charLimit) + "...";
                console.log(`üçû [BREADCRUMB] Truncated title for grid: ${displayTitle}`);
            }
            // -----------------------------------------------

            const squircle = document.createElement("div");
            squircle.className = "video-squircle";
            
            // Use the truncated title for the visual grid
            squircle.innerText = displayTitle;
            
            // CRITICAL: Pass 'fullTitle' to the modal so the user sees everything
            squircle.onclick = () => openModal(fullTitle, src.url, src.transcript);
            
            grid.appendChild(squircle);
        });
        
        console.log("üìç [STEP 10] All history records drawn.");
    }

    // --- 3. Add Single Squircle (Used for Live Session) ---
    function addSquircleToGrid(src) {
        console.log("üìç [LIVE] Adding single squircle to UI...");
        const grid = document.getElementById("video-grid");
        if (!grid) return;

        // 1. Get the full, original title
        const actualId = src.id || src.video_id || "New";
        const fullTitle = src.title || `Video ${actualId.substring(0,5)}`;

        // 2. APPLY TRUNCATION: Matches your main renderer logic
        const charLimit = 11; 
        let displayTitle = fullTitle;
        
        if (fullTitle.length > charLimit) {
            displayTitle = fullTitle.substring(0, charLimit) + "...";
            console.log(`üçû [BREADCRUMB] Live-added title truncated to: ${displayTitle}`);
        }

        const squircle = document.createElement("div");
        squircle.className = "video-squircle";
        
        // 3. Set the truncated text for the visual UI
        squircle.innerText = displayTitle;
        
        // 4. Pass the FULL title to the modal so the user sees everything
        squircle.onclick = () => {
            console.log(`üçû [BREADCRUMB] Opening modal from live-added squircle: ${fullTitle}`);
            openModal(fullTitle, src.url, src.transcript);
        };
        
        grid.appendChild(squircle);
        console.log("üìç [LIVE] UI Updated with new video.");
    }

    async function processSource() {
    console.log("üöÄ [ACTION] Process Source Button Clicked.");
    
    const urlInput = document.getElementById("url-input");
    const url = urlInput.value;
    const btn = document.querySelector(".primary-btn"); 
    const statusText = document.getElementById("video-status"); 

    if (!url) return alert("Please paste a YouTube URL!");

    // UI Lock - Prevents double submissions
    if (btn) {
        btn.disabled = true;
        btn.innerText = "‚è≥ Ingesting...";
    }
    if (statusText) statusText.innerText = "üîç Fetching YouTube Metadata...";

    try {
        console.log("üìç [TRANS-1] Sending POST request to backend...");
        const response = await fetch(`/api/${userUid}/projects/${projectId}/transcribe`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url: url })
        });

        if (response.ok) {
            const result = await response.json();
            console.log("üìç [TRANS-2] Backend Success:", result);

            // --- LIVE UPDATE LOGIC START (No logic tampered, only added) ---
            
            // 1. Update the local 'Single Source of Truth' array
            if (typeof allProjectSources !== 'undefined' && result.new_source) {
                allProjectSources.push(result.new_source);
                console.log("üçû [BREADCRUMB] Local allProjectSources updated.");
            }

            // 2. Trigger the AI Context list to re-render
            if (typeof renderContextSelectionList === "function") {
                renderContextSelectionList();
                console.log("üçû [BREADCRUMB] AI Context list re-rendered.");
            }

            // --- LIVE UPDATE LOGIC END ---

            // 1. Add new squircle to your grid using original function
            if (typeof addSquircleToGrid === "function") {
                addSquircleToGrid(result.new_source);
            }
            
            // 2. Update the Active Video Title in the bank
            const titleDisplay = document.getElementById("current-video-title");
            if (titleDisplay && result.new_source.title) {
                titleDisplay.innerText = result.new_source.title;
            }

            // 3. Reset UI
            urlInput.value = "";
            if (statusText) statusText.innerText = "‚úÖ Resource added to Bank!";
            
        } else {
            console.error("‚ùå [TRANS-ERR] Server returned error status.");
            alert("Transcription failed. Check if video has captions.");
        }
    } catch (err) {
        console.error("‚ùå [TRANS-ERR] Network crash:", err);
        alert("Connection error. Is the server running?");
    } finally {
        // UNLOCK UI
        if (btn) {
            btn.disabled = false;
            btn.innerText = "Process & Save to Bank";
            console.log("üìç [TRANS-3] Button re-enabled.");
        }
    }
}

    function updatePillDisplay() {
        const container = document.getElementById("context-pill-container");
        if (!container) return;
        container.innerHTML = "";

        selectedContext.forEach(source => {
            const pill = document.createElement("div");
            pill.className = "context-pill";
            // Show only first 10 chars in the pill
            const shortTitle = source.title.length > 10 ? source.title.substring(0, 10) + "..." : source.title;
            
            pill.innerHTML = `
                <span>${shortTitle}</span>
                <i class="fas fa-times" onclick="removeContext('${source.id}')" style="margin-left:8px; cursor:pointer;"></i>
            `;
            container.appendChild(pill);
        });
    }

    function removeContext(id) {
        // 1. Remove from array
        selectedContext = selectedContext.filter(s => s.id !== id);
        // 2. Remove gold glow from the squircle in the grid
        const squircle = document.querySelector(`.video-squircle[data-id="${id}"]`);
        if (squircle) squircle.classList.remove("selected");
        // 3. Refresh pills
        updatePillDisplay();
    }

    // --- 5. CHAT ASSISTANT LOGIC ---
    async function sendMessage() {
    const input = document.getElementById("chat-input");
    const message = input.value.trim();
    if (!message) return;

    // 1. Append User Message
    appendMessage("user", message);
    input.value = "";
    autoResize(input);

    // 2. Create the placeholder AI bubble IMMEDIATELY
    const chatWin = document.getElementById("chat-window");
    const modelDiv = document.createElement("div");
    modelDiv.className = "message-bubble model-msg"; // Use your existing class
    
    // Create an inner span for the text content
    const textContainer = document.createElement("span");
    textContainer.innerHTML = "<i>Chersey is thinking...</i>";
    modelDiv.appendChild(textContainer);
    
    chatWin.appendChild(modelDiv);
    chatWin.scrollTop = chatWin.scrollHeight;

    try {
        const response = await fetch(`/api/${userUid}/projects/${projectId}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                message: message, 
                selectedIds: selectedContext.map(c => c.id) 
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";

        // Clear the "Thinking..." text once stream starts
        textContainer.innerHTML = "";

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");

            lines.forEach(line => {
                if (line.trim().startsWith("data: ")) {
                    try {
                        const jsonStr = line.replace("data: ", "").trim();
                        const data = JSON.parse(jsonStr);
                        
                        if (data.text) {
                            fullText += data.text;
                            // UPDATE: Use innerText for streaming (safe and fast)
                            textContainer.innerText = fullText; 
                            chatWin.scrollTop = chatWin.scrollHeight;
                        }
                    } catch (e) { /* partial chunk */ }
                }
            });
        }

        // 3. FINAL STEP: Now that streaming is done, parse the Markdown and add the "+" button
        textContainer.innerHTML = marked.parse(fullText);
        
        const actionBtn = document.createElement("button");
        actionBtn.className = "add-to-notes-btn";
        actionBtn.innerHTML = '<i class="fas fa-plus"></i>';
        actionBtn.onclick = () => sendToNotes(fullText);
        modelDiv.appendChild(actionBtn);

    } catch (err) {
        console.error("‚ùå Stream Error:", err);
        textContainer.innerHTML = "<i>Connection lost.</i>";
    }
}

        function appendMessage(role, text) {
        const chatWin = document.getElementById("chat-window");
        if (!chatWin) return;

        const msgDiv = document.createElement("div");
        msgDiv.className = `message-bubble ${role === 'user' ? 'user-msg' : 'model-msg'}`;
        
        // Convert Markdown to HTML for visual consistency
        try {
            msgDiv.innerHTML = marked.parse(text); 
        } catch (e) {
            msgDiv.innerText = text;
        }

        // --- ADD THE "SCRATCHPAD" BUTTON ---
        if (role === 'model') {
            const actionBtn = document.createElement("button");
            actionBtn.className = "add-to-notes-btn";
            actionBtn.innerHTML = '<i class="fas fa-plus"></i>';
            actionBtn.title = "Send to Scratchpad";
            
            // This captures the 'text' at the moment of creation
            actionBtn.onclick = () => sendToNotes(text);
            
            msgDiv.appendChild(actionBtn);
        }

        chatWin.appendChild(msgDiv);
        chatWin.scrollTo({ top: chatWin.scrollHeight, behavior: 'smooth' });
    }

    async function loadChatHistory() {
        console.log("üìç [STEP 6] Loading chat history...");
        try {
            const response = await fetch(`/api/${userUid}/projects/${projectId}/chats`);
            if (response.ok) {
                const data = await response.json();
                data.history.forEach(m => appendMessage(m.role, m.text));
            }
        } catch (err) {
            console.warn("‚ö†Ô∏è No chat history found or server error.");
        }
    }


    async function loadChatHistory() {
        console.log("üìç [STEP 6] Loading chat history from Firestore...");
        try {
            // This URL must match your @app.get("/api/{uid}/projects/{project_id}/chats") in main.py
            const response = await fetch(`/api/${userUid}/projects/${projectId}/chats`);
            
            if (response.ok) {
                const data = await response.json();
                console.log("üìç [STEP 7] History data received:", data.history);

                const chatWindow = document.getElementById("chat-window");
                if (!chatWindow) return;

                // 1. Clear the window to prevent message duplication on refresh
                chatWindow.innerHTML = "";

                // 2. Loop through the documents fetched from the 'chats' collection
                data.history.forEach(msg => {
                    // Roles should be 'user' or 'model' to match your Firestore documents
                    appendMessage(msg.role, msg.text);
                });

                // 3. Auto-scroll to the bottom so the user sees the latest message
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
                console.log("üìç [STEP 8] Chat UI successfully populated.");
            } else {
                console.warn(`‚ö†Ô∏è Failed to fetch history. Status: ${response.status}`);
            }
        } catch (err) {
            console.error("‚ùå [ERROR] Network crash while loading history:", err);
        }
    }

        /**
     * Adjusts the height of a textarea based on the content length.
     * @param {HTMLElement} textarea - The textarea element to resize.
     */
    function autoResize(textarea) {
        // 1. Temporarily reset height to 'auto' to get accurate scrollHeight
        textarea.style.height = 'auto';

        // 2. Set the height to the scrollHeight (the total height of the text inside)
        // We add 'px' to make it a valid CSS value
        textarea.style.height = textarea.scrollHeight + 'px';
        
        // 3. (Optional) Prevent the container from growing too large
        // If you want a max height, handle it here or in CSS
    }

    // --- 6. chat context menu logic ---
    function toggleContextMenu() {
        const menu = document.getElementById("context-selection-menu");
        if (!menu) return;
        
        const isHidden = menu.style.display === "none" || menu.style.display === "";
        
        if (isHidden) {
            renderContextSelectionList();
            menu.style.display = "block";
        } else {
            menu.style.display = "none";
        }
    }

    function renderContextSelectionList() {
        const list = document.getElementById("context-list-items");
        if (!list) return;
        list.innerHTML = "";

        // allProjectSources must be populated in initializeProject
        allProjectSources.forEach(src => {
            const id = src.id || src.video_id;
            const isActive = selectedContext.some(item => item.id === id);
            
            const div = document.createElement("div");
            div.className = `context-item ${isActive ? 'active' : ''}`;
            
            div.innerHTML = `
                <span>${src.title}</span>
                <i class="fas ${isActive ? 'fa-check-circle' : 'fa-circle'}" 
                style="color: ${isActive ? '#ffcc00' : '#444'}; margin-left: 10px;"></i>
            `;
            
            div.onclick = () => {
                toggleContextItem(src);
                renderContextSelectionList(); // Refresh the checkmarks
            };
            
            list.appendChild(div);
        });
    }

    function toggleContextItem(src) {
        const id = src.id || src.video_id;
        const squircle = document.querySelector(`.video-squircle[data-id="${id}"]`);
        const index = selectedContext.findIndex(item => item.id === id);
        
        if (index === -1) {
            // Add to context
            selectedContext.push({ id: id, title: src.title });
            if (squircle) squircle.classList.add("selected");
        } else {
            // Remove from context
            selectedContext.splice(index, 1);
            if (squircle) squircle.classList.remove("selected");
        }
        
        updatePillDisplay(); // Refresh the rectangular pills in your chat bar
    }

    function clearAllContext() {
        selectedContext = [];
        document.querySelectorAll(".video-squircle").forEach(s => s.classList.remove("selected"));
        updatePillDisplay();
        document.getElementById("context-selection-menu").style.display = "none";
    }
    
    // --- EVENT LISTENERS ---
    window.addEventListener('load', () => {
        console.log("üìç [STEP 1.5] Window fully loaded. Firing initializeProject...");
        initializeProject();
    });


    // RHS notepad
    /** * NOTEPAD LOGIC: Focused on the RHS 
     */
     function applyFormat(command) {
        document.execCommand(command, false, null);
        document.getElementById("notepad-editor").focus();
    }

    // Export to Markdown logic
    function exportMD() {
        const title = document.getElementById("note-title").value || "Untitled";
        const content = document.getElementById("notepad-editor").innerText;
        const blob = new Blob([`# ${title}\n\n${content}`], {type: "text/markdown"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${title}.md`;
        link.click();
    }

    /**
     * BRIDGE LOGIC: Allows LHS to talk to RHS
     * Call this when you want an AI response to move to your notes!
     */
     function sendToNotes(text) {
        const editor = document.getElementById("notepad-editor");
        if (!editor) return;

        // 1. Convert Markdown to HTML
        const htmlSnippet = marked.parse(text);

        // 2. Append the content
        const noteEntry = `
            <div class="ai-contribution" style="border-left: 3px solid #bfecac; padding-left: 10px; margin: 15px 0;">
                ${htmlSnippet}
            </div>
            <br>
        `;
        editor.innerHTML += noteEntry;

        // 3. THE FIX: Manually trigger the save timer
        // This starts the 800ms countdown to Firebase
        if (typeof handleNoteInput === "function") {
            handleNoteInput();
        } else {
            // Fallback: If handleNoteInput isn't ready, call triggerAutoSave directly
            triggerAutoSave();
        }

        // 4. Scroll to show the new addition
        const scrollArea = document.querySelector(".editor-scroll-area");
        if (scrollArea) scrollArea.scrollTop = scrollArea.scrollHeight;
    }

    const lhs = document.getElementById('lhs');
    const rhs = document.getElementById('rhs');
    const resizer = document.getElementById('drag-bar');

    resizer.addEventListener('mousedown', function(e) {
        e.preventDefault();
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', stopResizing);
        resizer.classList.add('active');
    });

    function handleMouseMove(e) {
        // Calculate the new width as a percentage of the screen
        const containerWidth = document.getElementById('main-container').offsetWidth;
        const newLhsWidth = (e.clientX / containerWidth) * 100;

        // Set limits (e.g., LHS can't be smaller than 20% or larger than 80%)
        if (newLhsWidth > 20 && newLhsWidth < 80) {
            lhs.style.width = `${newLhsWidth}%`;
            rhs.style.width = `${100 - newLhsWidth}%`;
        }
    }

    function stopResizing() {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', stopResizing);
        resizer.classList.remove('active');
    }

    // ... existing applyFormat and exportMD functions ...

    function formatDoc(command, value = null) {
    const editor = document.getElementById('notepad-editor');
    
    if (editor) {
        // 1. Force focus back to the editor
        editor.focus();
        
        // 2. Execute the format command on the highlighted text
        document.execCommand(command, false, value);
        
        // 3. IMPORTANT: Manually trigger the Auto-Save logic 
        // because execCommand doesn't always fire the 'input' event
        if (typeof triggerAutoSave === 'function') {
            triggerAutoSave(); 
        }
    } else {
        console.error("Could not find notepad-editor. Are you on the right page?");
    }
}

async function triggerAutoSave() {
    const editor = document.getElementById("notepad-editor");
    const titleField = document.getElementById("note-title");
    const syncStatus = document.getElementById("sync-status");

    if (!editor || !titleField) return;

    // IMPORTANT: Grab innerHTML to keep bold/italic/lists
    const notesContent = editor.innerHTML; 
    const notesTitle = titleField.value;

    if (syncStatus) syncStatus.innerText = "Saving...";

    try {
        const response = await fetch(`/api/${userUid}/projects/${projectId}/notes`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                title: notesTitle, 
                content: notesContent 
            })
        });

        if (response.ok && syncStatus) {
            syncStatus.innerText = "Saved to Cloud";
        }
    } catch (err) {
        if (syncStatus) syncStatus.innerText = "Offline - Retry later";
    }
}

async function loadProjectData() {
    const response = await fetch(`/api/${userUid}/projects/${projectId}`);
    const project = await response.json();

    if (project.notes_html) {
        // Inject the HTML tags directly into the contenteditable div
        document.getElementById("notepad-editor").innerHTML = project.notes_html;
    }
    
    if (project.notes_title) {
        document.getElementById("note-title").value = project.notes_title;
    }
}

// This ensures the elements exist before we try to attach listeners
document.addEventListener('DOMContentLoaded', () => {
    loadProjectData();
    const editor = document.getElementById("notepad-editor");
    const titleField = document.getElementById("note-title");

    if (editor && titleField) {
        // 1. Listen for typing or formatting in the notepad
        editor.addEventListener("input", handleNoteInput);

        // 2. Listen for changes in the title
        titleField.addEventListener("input", handleNoteInput);
    }
});

// 1. DOWNLOAD AS PDF
function downloadPDF() {
    const element = document.getElementById('notepad-editor');
    const title = document.getElementById('note-title').value || 'My_Research_Notes';
    
    const opt = {
        margin:       1,
        filename:     `${title}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    // New worker instance to handle the conversion
    html2pdf().set(opt).from(element).save();
}

// 2. DOWNLOAD AS MARKDOWN (.md)
function downloadMarkdown() {
    const content = document.getElementById('notepad-editor').innerText; // Using innerText to get raw text
    const title = document.getElementById('note-title').value || 'Notes';
    
    const blob = new Blob([content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    a.href = url;
    a.download = `${title}.md`;
    a.click();
    URL.revokeObjectURL(url); // Clean up memory
}

function exportTXT() {
    // 1. Get the HTML content from the notepad
    const htmlContent = document.getElementById('notepad-editor').innerHTML;
    
    // 2. Convert HTML to plain text (replaces <br> and <div> with newlines)
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = htmlContent;
    const plainText = tempDiv.textContent || tempDiv.innerText || "";

    // 3. Get the project name for the filename
    const projectName = document.getElementById('project-title-display').innerText || 'Project_Notes';
    const fileName = `${projectName.replace(/\s+/g, '_')}_Notes.txt`;

    // 4. Create the Blob and trigger download
    const blob = new Blob([plainText], { type: 'text/plain' });
    const link = document.createElement('a');
    
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    
    // Append to body, click, and remove
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log("üìÑ [EXPORT] Text file downloaded successfully.");
}


// Function to show/hide the popup
function toggleNotionPopup(show) {
    document.getElementById('notion-popup').style.display = show ? 'flex' : 'none';
}

async function triggerActualSync() {
    toggleNotionPopup(false);
    
    // Grabbing data from your anchored header and notepad
    const title = document.getElementById("project-title-display").innerText;
    const notes = document.getElementById("notepad-editor").innerText;

    // Optional: show a loading state here
    try {
        const response = await fetch("/api/export/notion", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content: notes })
        });

        const result = await response.json();
        if (response.ok) {
            alert("‚úÖ Notes exported to Raghunath's Notion!");
        } else {
            console.error("Notion API Error:", result);
            alert("‚ùå Export failed. Did you 'Add Connection' in Notion?");
        }
    } catch (err) {
        alert("‚ùå Connection error. Check backend.");
    }
}

// async function loadProjectContext(projectId) {
//     // 1. Reference the subcollection where your transcripts are stored
//     const sourcesRef = collection(db, "projects", projectId, "sources");
    
//     try {
//         const querySnapshot = await getDocs(sourcesRef);
        
//         // 2. Map the documents into our global 'allProjectSources' array
//         allProjectSources = querySnapshot.docs.map(doc => ({
//             id: doc.id,
//             ...doc.data() // This must contain 'transcript' and 'title' fields
//         }));

//         console.log("üìÇ Context Loaded:", allProjectSources.length, "sources found.");
        
//         // 3. Immediately fill the research dropdown with these titles
//         populateResearchDropdown();
        
//     } catch (error) {
//         console.error("Error fetching context:", error);
//     }
// }

function populateResearchDropdown() {
    const selector = document.getElementById("research-context-selector");
    if (!selector) {
        console.warn("‚ö†Ô∏è [WARNING] Research selector element not found in DOM.");
        return;
    }

    // 1. Clear current options and add the default prompt
    selector.innerHTML = '<option value="">Select Video Context...</option>';

    // 2. Loop through your globally stored sources
    allProjectSources.forEach(source => {
        const option = document.createElement("option");
        
        // Use the same unique ID you use for your chatbot context
        option.value = source.id || source.videoId; 
        option.textContent = source.title || "Untitled Video";
        
        selector.appendChild(option);
    });

    console.log(`‚úÖ [UI] Research dropdown populated with ${allProjectSources.length} sources.`);
}

// Add this global variable at the top of your script
let lastResearchLinks = []; 

async function runDeepResearch() {
    const selector = document.getElementById("research-context-selector");
    const selectedId = selector.value;
    const resultsGrid = document.getElementById("research-results-grid");

    if (!selectedId) return alert("Please select a video context first!");

    const selectedSource = allProjectSources.find(s => s.id === selectedId);
    const transcriptText = selectedSource ? selectedSource.transcript : "";

    resultsGrid.innerHTML = `<div style="text-align:center; padding: 40px; color: #bfecac;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Llama 3 is analyzing and searching Tavily...</p>
                             </div>`;

    try {
        const response = await fetch("/api/research/agent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: transcriptText })
        });

        if (!response.ok) throw new Error("Backend search failed");
        const data = await response.json();
        
        // --- THE FIX ---
        lastResearchLinks = data.results || []; // Store them globally for toggleBookmark to refresh
        renderResearchCards(lastResearchLinks); // Use the dedicated renderer
        
    } catch (err) {
        console.error("‚ùå Research Error:", err);
        resultsGrid.innerHTML = "<p style='color: #ff4d4d; text-align: center;'>Failed to connect to AI Agent.</p>";
    }
}


function renderResearchCards(links) {
    const container = document.getElementById("research-results-grid");
    if (!container) return;
    
    // Clear the "Select context" placeholder or previous results
    container.innerHTML = ""; 

    links.forEach((link) => {
        // 1. Check if this specific URL exists in our loaded bookmarks
        const isBookmarked = allBookmarks.some(b => b.url === link.url);
        
        // 2. Select the correct icon and class based on status
        const iconClass = isBookmarked ? "fas fa-bookmark" : "far fa-bookmark";
        const btnClass = isBookmarked ? "bookmark-btn active" : "bookmark-btn";

        // 3. Build the card HTML
        container.innerHTML += `
            <div class="research-card" style="background: #1a1a1a; border: 1px solid #333; padding: 15px; border-radius: 10px; margin-bottom: 12px; position: relative;">
                
                <button onclick="toggleBookmark('${link.url}', '${link.title.replace(/'/g, "\\'")}')" class="${btnClass}" 
                        style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #bfecac; cursor: pointer; font-size: 1.2rem;">
                    <i class="${iconClass}"></i>
                </button>

                <h4 style="margin: 0 0 8px 0; color: #fff; font-size: 0.95rem; padding-right: 25px;">${link.title}</h4>
                
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 12px;">
                    ${link.content ? link.content.substring(0, 150) + '...' : 'Saved from previous research.'}
                </p>
                
                <a href="${link.url}" target="_blank" style="color: #bfecac; font-size: 0.85rem; text-decoration: none; font-weight: bold;">
                    Read Source ‚Üí
                </a>
            </div>
        `;
    });
}


let allBookmarks = []; // Global state for persistence


async function loadBookmarks(projId) {
    console.log("‚≠ê [REMAP] Loading bookmarks via Python API...");
    try {
        const response = await fetch(`/api/${userUid}/projects/${projId}/bookmarks`);
        if (!response.ok) throw new Error("Failed to fetch bookmarks");
        
        const data = await response.json();
        allBookmarks = data.bookmarks || []; 
        console.log(`‚úÖ Loaded ${allBookmarks.length} bookmarks via Backend.`);
    } catch (err) {
        console.error("‚ùå Backend Bookmark Error:", err);
    }
}

async function toggleBookmark(url, title) {
    console.log("üìå [TOGGLE] Initiating sync with backend...");
    try {
        const response = await fetch(`/api/${userUid}/projects/${projectId}/bookmarks/toggle`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url, title })
        });

        if (!response.ok) throw new Error("Toggle request failed");

        // 1. Refresh the global allBookmarks array from the database
        await loadBookmarks(projectId); 

        // 2. SMART RE-RENDER: Decide what to show
        // If the user just performed a search, keep those search results visible.
        // If not, show the refreshed saved bookmarks list.
        if (lastResearchLinks && lastResearchLinks.length > 0) {
            console.log("‚ôªÔ∏è Refreshing search results with new bookmark state...");
            renderResearchCards(lastResearchLinks);
        } else {
            console.log("‚ôªÔ∏è Refreshing saved bookmarks view...");
            renderResearchCards(allBookmarks);
        }
        
    } catch (err) {
        console.error("‚ùå Toggle Error:", err);
    }
}

function renderSavedBookmarks() {
    const container = document.getElementById("research-results-grid");
    if (!container) return;

    // Clear the "Select context to begin" placeholder
    container.innerHTML = ""; 

    allBookmarks.forEach((link) => {
        // Since these are from the 'bookmarks' collection, they are ALWAYS active/filled
        const iconClass = "fas fa-bookmark"; 
        const btnClass = "bookmark-btn active";

        container.innerHTML += `
            <div class="research-card" style="background: #1a1a1a; border: 1px solid #bfecac; padding: 15px; border-radius: 10px; margin-bottom: 12px; position: relative;">
                <button onclick="toggleBookmark('${link.url}', '${link.title.replace(/'/g, "\\'")}')" class="${btnClass}" 
                        style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #bfecac; cursor: pointer; font-size: 1.2rem;">
                    <i class="${iconClass}"></i>
                </button>
                <h4 style="margin: 0 0 8px 0; color: #fff; font-size: 0.95rem; padding-right: 25px;">${link.title}</h4>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 12px;">(Saved Resource)</p>
                <a href="${link.url}" target="_blank" style="color: #bfecac; font-size: 0.85rem; text-decoration: none; font-weight: bold;">Read Source ‚Üí</a>
            </div>
        `;
    });
}

// CRUMBSSSS!!!



// The Debouncer (prevents 100 requests per minute)
let autoSaveTimeout;
function handleNoteInput() {
    clearTimeout(autoSaveTimeout);
    // Wait 800ms after the user stops typing to trigger the save
    autoSaveTimeout = setTimeout(triggerAutoSave, 800);
}

</script>

</body>
</html>